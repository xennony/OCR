# Обзор структуры приложения OpenRecall

Давайте разберем каждый файл приложения OpenRecall более подробно, включая его функции и взаимодействие с другими файлами.

## 1. app.py (Основное приложение Flask)

**Цель:** Этот файл является сердцем приложения. Он создает веб-сервер с помощью Flask, определяет маршруты (URL-адреса), которые обрабатывают различные запросы пользователя, и отображает HTML-страницы. Также он запускает фоновый поток для непрерывной записи скриншотов.

### Ключевые компоненты:
- **Flask App:** Инициализирует Flask приложение (app = Flask(__name__)).
  
### Маршруты:
- `/:` Отображает временную шкалу скриншотов. Использует слайдер для перемещения по истории.
- `/search:` Обрабатывает поисковые запросы. Получает векторное представление поискового запроса, сравнивает его с векторными представлениями текста на скриншотах и отображает наиболее похожие результаты.
- `/static/<filename>:` Отдает статические файлы (скриншоты).

### Шаблоны:
Использует Jinja2 для рендеринга HTML. Базовый шаблон (base_template) определяет общую структуру страницы, а блоки content заполняются динамическим контентом в зависимости от маршрута.

### Фильтры Jinja2:
- `human_readable_time` и `timestamp_to_human_readable` используются для форматирования времени в шаблонах.

### Фоновый поток:
Запускает функцию `record_screenshots_thread` из `screenshot.py` в отдельном потоке для записи скриншотов в фоне.

---

## 2. database.py (Взаимодействие с базой данных)

**Цель:** Этот файл отвечает за все взаимодействия с базой данных SQLite. Он определяет функции для создания таблицы, вставки новых записей, получения всех записей и получения временных меток.

### Ключевые функции:
- `create_db()`: Создает таблицу `entries` в базе данных, если она не существует.
- `get_all_entries()`: Возвращает все записи из базы данных в виде списка `namedtuple Entry`.
- `get_timestamps()`: Возвращает список временных меток всех скриншотов, отсортированных в обратном хронологическом порядке.
- `insert_entry()`: Вставляет новую запись в базу данных. Принимает текст, временную метку, векторное представление текста, имя приложения и заголовок окна.

---

## 3. config.py (Настройки)

**Цель:** Хранит конфигурацию приложения, такую как пути к папкам для хранения данных и аргументы командной строки.

### Ключевые переменные:
- `appdata_folder`: Путь к папке приложения, где хранятся скриншоты и база данных.
- `screenshots_path`: Путь к папке для хранения скриншотов.
- `db_path`: Путь к файлу базы данных.
- `args`: Результат парсинга аргументов командной строки. Например, `--storage-path` позволяет указать пользовательский путь для хранения данных.

---

## 4. nlp.py (Обработка естественного языка)

**Цель:** Этот файл отвечает за NLP функциональность, включая получение векторных представлений текста и вычисление косинусной близости.

### Ключевые функции:
- `get_embedding(text)`: Получает векторное представление текста с помощью SentenceTransformer. Разбивает текст на предложения, получает векторное представление для каждого предложения и возвращает среднее значение векторов.
- `cosine_similarity(a, b)`: Вычисляет косинусную близость между двумя векторами.

---

## 5. ocr.py (Оптическое распознавание символов)

**Цель:** Извлекает текст из изображений скриншотов.

### Ключевые компоненты:
- `ocr_predictor`: Загружает предобученную модель OCR из библиотеки doctr.
  
### Функции:
- `extract_text_from_image(image)`: Принимает изображение в качестве аргумента и возвращает извлеченный текст.

---

## 6. screenshot.py (Работа со скриншотами)

**Цель:** Содержит функции для создания скриншотов, сравнения изображений и сохранения скриншотов вместе с извлеченным текстом и векторными представлениями в базу данных.

### Ключевые функции:
- `mean_structured_similarity_index(img1, img2)`: Вычисляет индекс структурного сходства (SSIM) между двумя изображениями.
- `is_similar(img1, img2)`: Определяет, похожи ли два изображения на основе SSIM.
- `take_screenshots()`: Создает скриншоты экранов.
- `record_screenshots_thread()`: Функция, которая запускается в фоновом потоке. Делает скриншоты, сравнивает их с предыдущими, и если они отличаются, сохраняет новый скриншот в базу данных вместе с извлеченным текстом и векторным представлением.

---

## 7. utils.py (Вспомогательные функции)

**Цель:** Содержит различные вспомогательные функции.

### Ключевые функции:
- `human_readable_time(timestamp)`: Преобразует временную метку в удобочитаемый формат.
- `timestamp_to_human_readable(timestamp)`: Преобразует временную метку в формат YYYY-MM-DD HH:MM:SS.
- `get_active_app_name()`: Возвращает имя активного приложения. Реализовано по-разному для Windows, macOS и Linux.
- `get_active_window_title()`: Возвращает заголовок активного окна.
- `is_user_active()`: Проверяет, активен ли пользователь (не бездействует ли).

---

## Взаимодействие между файлами

Взаимодействие между файлами происходит через импорт функций и переменных. Например, `app.py` импортирует функции из `database.py`, `screenshot.py` и `utils.py`. `screenshot.py` импортирует функции из `ocr.py`, `nlp.py`, `database.py` и `config.py`. Это позволяет модулям взаимодействовать друг с другом и формировать целостное приложение.
